<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Support Chat — BREAKWAY GAS</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .chat-container{max-width:820px;margin:16px auto}
    .messages{border:1px solid rgba(0,0,0,0.06);padding:12px;height:360px;overflow:auto;background:var(--card-bg,#fff);}
    .msg{margin-bottom:8px}
    .msg .meta{font-size:12px;color:var(--muted,#666)}
    .msg.me{text-align:right}
    .msg .bubble{display:inline-block;padding:8px 10px;border-radius:8px;max-width:78%}
    .msg.me .bubble{background:#DCF8C6}
    .msg.them .bubble{background:#f1f0f0}
  </style>
</head>
<body>
  <button class="back-btn" onclick="history.back()">← Back</button>
  <header class="topbar">Customer Support Chat</header>
  <div class="card chat-container">
    <div style="margin-bottom:8px">This is a simple chat UI. Messages are stored locally and are visible to agents via the support dashboard.</div>
    <div id="messages" class="messages">Loading…</div>
    <form id="chatForm" style="display:flex;gap:8px;margin-top:8px">
      <input id="chatInput" placeholder="Type your message..." style="flex:1;padding:8px" autocomplete="off" />
      <button class="btn">Send</button>
    </form>
  </div>
  <script>
    function readTickets(){ try{ return JSON.parse(localStorage.getItem('supportTickets')||'[]')||[] }catch(e){ return []; } }
    function writeTickets(list){ try{ localStorage.setItem('supportTickets', JSON.stringify(list)); }catch(e){} }
    function ensureCustomerTicket(){
      const currentUserId = sessionStorage.getItem('currentUserId');
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const currentUser = users.find(u => u.id === currentUserId);
      var list = readTickets();
      var ticket = null;
      if (currentUser){ ticket = list.find(function(t){ return t.userId === currentUser.id && t.status !== 'resolved'; }); }
      if (!ticket && currentUser){
        ticket = { id: 'C'+Date.now().toString(36), userId: currentUser.id, name: currentUser.name, contact: (currentUser.mobile||currentUser.email), message:'', status:'open', createdAt:new Date().toISOString(), thread:[] };
        list.push(ticket); writeTickets(list);
      }
      return ticket;
    }
    var ticket = ensureCustomerTicket();
    function renderThread(){
      var list = readTickets();
      var t = list.find(function(x){ return x.id === ticket.id; });
      var out = '';
      if (!t || !t.thread || !t.thread.length){ out = '<p class="text-muted">No messages yet. Say hi to support!</p>'; document.getElementById('messages').innerHTML = out; return; }
      t.thread.forEach(function(m){ out += '<div class="msg '+(m.from==='agent'?'them':'me')+'"><div class="bubble">'+escapeHtml(m.text)+'</div><div class="meta">'+(m.from==='agent'?'Support':'You')+' · '+(new Date(m.at)).toLocaleString()+'</div></div>'; });
      document.getElementById('messages').innerHTML = out; document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,function(c){return{'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c];}); }
    document.getElementById('chatForm').addEventListener('submit', function(e){ e.preventDefault(); var input = document.getElementById('chatInput'); var txt = input.value.trim(); if(!txt || !ticket) return; var list = readTickets(); var t = list.find(function(x){ return x.id === ticket.id; }); if(!t){ t = ticket; list.push(t); }
      t.thread = t.thread || [];
      t.thread.push({ from:'customer', text: txt, at: new Date().toISOString() });
      writeTickets(list); input.value = ''; renderThread();
    });
    document.addEventListener('DOMContentLoaded', function(){ renderThread(); });
  </script>
</body>
</html>